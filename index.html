<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miller Lab: 7¬±2 y Chunking</title>
  <meta name="description" content="Laboratorio interactivo para experimentar con el N√∫mero M√°gico 7¬±2 y el Chunking.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f9fa;       /* Un gris muy claro */
      --card: #ffffff;     /* Blanco puro */
      --text: #212529;     /* Negro suave */
      --muted: #6c757d;     /* Gris para texto secundario */
      --border: #e9ecef;   /* Borde sutil */
      --brand: #007bff;     /* Azul primario */
      --ok: #28a745;       /* Verde */
      --warn: #fd7e14;     /* Naranja */
      --bad: #dc3545;      /* Rojo */
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,.04);
    }
    * { box-sizing: border-box; }
    html { font-size: 16px; }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .muted { color: var(--muted); }
    
    .wrap {
      max-width: 800px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
    }

    /* --- Cabecera y Navegaci√≥n --- */
    header {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header .wrap {
      padding-top: 0; padding-bottom: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0;
    }
    h1 .muted {
      font-weight: 400;
      color: var(--muted);
    }
    nav {
      display: flex;
      gap: 0.5rem;
    }
    .tab {
      display: inline-block;
      font: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.5rem 0.8rem;
      border: 1px solid transparent;
      border-radius: 99px;
      background: none;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tab:hover {
      background: var(--bg);
      color: var(--text);
    }
    .tab.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    /* --- Contenido Principal y Tarjetas --- */
    main { padding-top: 2rem; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem 1.75rem;
      margin-bottom: 1.5rem;
    }
    h2 {
      font-size: 1.75rem;
      margin: 0 0 1rem 0;
    }
    h3 {
      font-size: 1.25rem;
      margin: 1.5rem 0 0.75rem 0;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.25rem;
    }
    p { margin: 0 0 1rem 0; }
    .hidden { display: none; }
    
    /* --- Controles (Selects, Botones) --- */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      padding: 0.75rem;
      background: var(--bg);
      border-radius: var(--radius);
      margin-top: 1.5rem;
    }
    .control-group {
      display: flex;
      flex-direction: column;
    }
    .control-group label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }
    select, input[type="text"], input[type="number"], button {
      font: inherit;
      font-size: 1rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      outline-color: var(--brand);
    }
    input[type="number"] { width: 70px; }
    button {
      cursor: pointer;
      background: #f1f3f5; /* gris claro */
      color: var(--text);
      font-weight: 600;
      border: 1px solid var(--border);
      transition: all 0.1s ease;
    }
    button:hover {
      border-color: #ced4da;
    }
    button.primary {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }
    button.primary:hover {
      filter: brightness(1.05);
    }
    .w100 { width: 100%; }
    details summary {
      font-weight: 600;
    }
    
    /* --- Etapas del experimento --- */
    .stage {
      margin-top: 1.5rem;
      padding: 1.5rem;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      background: #fafbff;
      position: relative;
    }
    .countdown-timer {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    .countdown-timer span {
      width: 12px; height: 12px;
      border-radius: 50%;
      background: var(--border);
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    .countdown-timer.animate span.active {
      opacity: 1;
      background: var(--brand);
    }
    .sequence {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80px;
      font-size: 2rem;
      letter-spacing: 0.5rem;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      padding: 1.5rem;
    }
    .progress {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.5rem;
    }
    .feedback {
      font-weight: 600;
    }
    .feedback .success { color: var(--ok); }
    .feedback .warning { color: var(--warn); }
    .feedback .error { color: var(--bad); }
    .feedback-log {
      margin-top: 1rem;
      max-height: 140px;
      overflow-y: auto;
      padding: 0.75rem;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.85rem;
    }
    .feedback-log p {
      margin: 0 0 0.5rem 0;
    }
    
    /* --- KPI boxes --- */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .kpi-box {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .kpi-box .label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .kpi-box .value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .chunk-results {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .chunk-results th, .chunk-results td {
      border: 1px solid var(--border);
      padding: 0.75rem;
      text-align: left;
    }
    .chunk-results th {
      background: #f1f3f5;
      font-size: 0.9rem;
    }
    .chunk-results td:nth-child(2), .chunk-results td:nth-child(3) {
      width: 120px;
      text-align: center;
    }
    .chunk-results .muted { text-align: center; color: var(--muted); }
    .chunk-results code { 
      font-size: 0.85rem; 
      background: #f1f3f5;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      display: inline-block;
    }
    .chunk-results .success { color: var(--ok); font-weight: 600; }
    .chunk-results .error { color: var(--bad); font-weight: 600; }

    /* --- Resultados --- */
    canvas#chart {
      width: 100%;
      height: 240px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 1rem;
    }

    /* --- Footer --- */
    footer {
      padding: 2rem 0;
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
    }
    footer a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 600;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .kofi-button {
      display: inline-block;
      background: #fd7e14;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 99px;
      text-decoration: none;
      font-weight: 600;
      margin-left: 0.5rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(253, 126, 20, .3);
    }
    .kofi-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(253, 126, 20, .4);
    }
  </style>
</head>
<body>

  <header>
    <div class="wrap">
      <h1>Miller <span class="muted">Lab</span></h1>
      <nav aria-label="Secciones">
        <button class="tab active" data-tab="intro">Inicio</button>
        <button class="tab" data-tab="span">7¬±2</button>
        <button class="tab" data-tab="chunk">Chunking</button>
        <button class="tab" data-tab="result">Resultados</button>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <section id="intro">
      <div class="card">
        <h2>Bienvenido al Laboratorio Miller</h2>
        <p>
          Esta es una herramienta simple para explorar dos conceptos clave de la psicolog√≠a cognitiva descritos por George A. Miller:
        </p>
        <ul>
          <li><strong>N√∫mero M√°gico 7¬±2:</strong> Mide el l√≠mite de tu memoria a corto plazo (span de memoria).</li>
          <li><strong>Chunking:</strong> Comprueba c√≥mo agrupar la informaci√≥n en "chunks" (trozos) con significado te permite superar ese l√≠mite.</li>
        </ul>
        <p>Los datos se guardan solo en tu navegador. ¬°Empieza cuando quieras!</p>
        <div class="controls" style="background: none; padding-left: 0;">
          <button class="primary" data-go="span">Empezar Test 7¬±2</button>
          <button data-go="chunk">Ir a Chunking</button>
        </div>
      </div>
    </section>

    <section id="span" class="hidden">
      <div class="card">
        <h2>Experimento: N√∫mero m√°gico 7 ¬± 2</h2>
        <p>Ver√°s una secuencia de √≠tems, uno por uno. Cuando termine, escr√≠bela <strong>en el orden exacto</strong>. La longitud se ajustar√° autom√°ticamente seg√∫n tus aciertos.</p>
        
        <div class="controls">
          <div class="control-group">
            <label for="stimulus">Est√≠mulo</label>
            <select id="stimulus">
              <option value="digits">D√≠gitos (0‚Äì9)</option>
              <option value="letters">Letras (A‚ÄìZ)</option>
              <option value="words">Palabras cortas</option>
            </select>
          </div>
          <div class="control-group">
            <label for="speed">Velocidad</label>
            <select id="speed">
              <option value="1000">Lenta (1s/√≠tem)</option>
              <option value="750" selected>Media (0.75s/√≠tem)</option>
              <option value="500">R√°pida (0.5s/√≠tem)</option>
            </select>
          </div>
          <div class="control-group">
            <label for="trials">Intentos</label>
            <input id="trials" type="number" min="6" max="20" value="12" />
          </div>
          <button id="startSpan" class="primary">Iniciar</button>
          <button id="resetSpan" title="Borrar datos de esta sesi√≥n">Reiniciar</button>
        </div>

        <div id="spanStage" class="stage hidden">
          <div id="countdown" class="countdown-timer">
            <span></span><span></span><span></span>
          </div>
          
          <div id="sequence" class="sequence hidden" aria-live="polite">‚Äî</div>
          
          <div id="spanInputGroup" class="hidden">
            <input id="response" type="text" autocomplete="off" class="w100" placeholder="Escribe la secuencia y pulsa Enter" />
            <div class="progress"><span id="progress">0</span> / <span id="total">0</span> intentos</div>
            <div id="feedback" class="feedback"></div>
            <div id="feedbackLog" class="feedback-log hidden"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="chunk" class="hidden">
      <div class="card">
        <h2>Experimento: Chunking (agrupamiento)</h2>
        <p>Har√°s tres comparaciones con secuencias distintas: primero ver√°s versiones sin guiones y, tras una pausa, sus equivalentes agrupados con guiones para comprobar c√≥mo cambia tu recuerdo.</p>

        <div class="controls">
          <div class="control-group">
            <label for="chunkScenario">Escenario</label>
            <select id="chunkScenario">
              <option value="letters" selected>Letras vs. Siglas</option>
              <option value="phone">N√∫mero largo vs. Tel√©fono</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>
          <button id="startChunk" class="primary">Iniciar comparaci√≥n</button>
        </div>
        
        <details style="margin-top: 1rem;">
          <summary style="color: var(--muted); cursor: pointer; font-size: 0.9rem;">Configurar texto personalizado</summary>
          <div class="controls" style="margin-top: 0.5rem;">
            <p style="margin: 0; font-size: 0.85rem; color: var(--muted); flex: 1 0 100%;">Puedes introducir hasta tres secuencias separadas por comas, punto y coma, barra vertical o saltos de l√≠nea.</p>
            <div class="control-group w100">
              <label for="customRaw">Texto sin agrupar</label>
              <input id="customRaw" class="w100" type="text" value="IBMSONYFBICNNUNESCO" />
            </div>
            <div class="control-group w100">
              <label for="customGrouped">Texto agrupado (usa espacios/guiones)</label>
              <input id="customGrouped" class="w100" type="text" value="IBM-SONY-FBI-CNN-UNESCO" />
            </div>
          </div>
        </details>

        <div id="chunkStage" class="stage hidden">
          <div id="chunkCountdown" class="countdown-timer">
            <span></span><span></span><span></span>
          </div>
          
          <div id="chunkDisplay" class="sequence hidden">‚Äî</div>
          
          <div id="chunkInputGroup" class="hidden">
            <input id="chunkResponse" type="text" class="w100" placeholder="Escribe lo que recuerdes y pulsa Enter" />
            <div class="progress">Ensayo <span id="chunkTrial">1</span> / <span id="chunkTotal">6</span></div>
            <div id="chunkFeedback" class="feedback"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="result" class="hidden">
      <div class="card">
        <h2>Tus Resultados</h2>
        <div class="kpi-grid">
          <div class="kpi-box">
            <div class="label">Span Estimado</div>
            <div class="value" id="kpiSpan">‚Äî</div>
          </div>
          <div class="kpi-box">
            <div class="label">Precisi√≥n (Span)</div>
            <div class="value" id="kpiAcc">‚Äî</div>
          </div>
          <div class="kpi-box">
            <div class="label">Ventaja Chunking</div>
            <div class="value" id="kpiChunk">‚Äî</div>
          </div>
        </div>
        
        <h3>Resultados de Chunking (√öltimo Ensayo)</h3>
        <table id="chunkTable" class="chunk-results">
          <thead>
            <tr>
              <th>Modo</th>
              <th>Precisi√≥n</th>
              <th>Tiempo (seg)</th>
              <th>Tu Respuesta</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="4" class="muted">Realiza el test de Chunking para ver resultados.</td>
            </tr>
          </tbody>
        </table>

        <h3>Progreso del Span</h3>
        <canvas id="chart" width="640" height="240"></canvas>

        <div class="controls" style="margin-top: 2rem;">
          <button id="exportCSV">Exportar CSV</button>
          <button id="clearAll">Borrar datos</button>
        </div>
      </div>
    </section>

  </main>

  <footer>
    <div class="wrap">
      Dise√±ado por <a href="https://jlmirall.es" target="_blank" rel="noopener noreferrer">Jos√© Luis Miralles Bono</a>.
      <br>
      Si te ha gustado, puedes invitarme a una 
      <a href="https://ko-fi.com/miralles" class="kofi-button" target="_blank" rel="noopener noreferrer">Horchata ü•§</a>
    </div>
  </footer>

  <script>
    (function(){
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      // --- Estado y Persistencia ---
      const state = {
        span: { trials: [], estimate: null },
        chunk: { results: [] }
      };
      const storeKey = 'miller-lab-v2-storage';
      try { const saved = JSON.parse(localStorage.getItem(storeKey)); if(saved){ Object.assign(state, saved); } } catch(e){}
      const persist = () => localStorage.setItem(storeKey, JSON.stringify(state));

      // --- Navegaci√≥n ---
      function show(tab){
        $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
        ['intro','span','chunk','result'].forEach(id=>{
          const el = document.getElementById(id);
          if(el) el.classList.toggle('hidden', id!==tab);
        });
        if(tab==='result') {
          drawChart();
          populateChunkTable(); // <-- MEJORA: Rellenar tabla de chunking
        }
      }
      $$('.tab').forEach(t=>t.addEventListener('click', ()=>show(t.dataset.tab)));
      $$('#intro [data-go]').forEach(b=>b.addEventListener('click', ()=>show(b.dataset.go)));

      // --- Utilidades ---
      function normalize(s){ return s.replace(/[\s-]+/g,'').toUpperCase(); }
      function escapeHtml(str){ return str.replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }
      
      function levenshtein(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
        for (let i = 0; i <= a.length; i++) { matrix[0][i] = i; }
        for (let j = 0; j <= b.length; j++) { matrix[j][0] = j; }
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j][i - 1] + 1,      // Deletion
              matrix[j - 1][i] + 1,      // Insertion
              matrix[j - 1][i - 1] + cost // Substitution
            );
          }
        }
        return matrix[b.length][a.length];
      }

      function getSimilarity(a, b) {
        const normA = normalize(a);
        const normB = normalize(b);
        const maxLen = Math.max(normA.length, normB.length);
        if (maxLen === 0) return 1;
        const dist = levenshtein(normA, normB);
        return 1 - (dist / maxLen);
      }
      
      function download(filename, data, type){
        const blob = new Blob([data], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      
      // --- Cuenta atr√°s Visual ---
      const countdownEl = $('#countdown');
      const chunkCountdownEl = $('#chunkCountdown');
      
      function runCountdown(el, callback) {
        el.classList.remove('hidden');
        el.classList.add('animate');
        const dots = Array.from(el.querySelectorAll('span'));
        let i = 0;
        const timer = setInterval(() => {
          dots.forEach((dot, idx) => {
            dot.classList.toggle('active', idx === i);
          });
          i++;
          if (i >= dots.length) {
            clearInterval(timer);
            setTimeout(() => {
              el.classList.remove('animate');
              dots.forEach(dot => dot.classList.remove('active'));
              el.classList.add('hidden');
              callback();
            }, 300);
          }
        }, 600);
      }

      // ------------------------- SPAN -------------------------
      const seqEl = $('#sequence');
      const respEl = $('#response');
      const progressEl = $('#progress');
      const totalEl = $('#total');
      const feedbackEl = $('#feedback');
      const feedbackLogEl = $('#feedbackLog');
      const startBtn = $('#startSpan');
      const resetBtn = $('#resetSpan');
      const trialsInput = $('#trials');

      let controller = { running: false, index: 0, total: 12, len: 5, reversals: [], lastDir: null, currentSeq: '', type: 'digits', speed: 750, timer: null };

      function makeDigits(len){ return Array(len).fill(0).map(()=>Math.floor(Math.random()*10)).join(''); }
      function makeLetters(len){ 
        const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // omitimos O/I
        return Array(len).fill(0).map(()=>letters[Math.floor(Math.random()*letters.length)]).join('');
      }
      function makeWords(len){
        const pool = ['sol','luz','mar','ola','voz','ave','pan','sal','pez','red','voz','cal','paz','mas','gas','fin','luz','sol','eco','mes'];
        return Array(len).fill(0).map(()=>pool[Math.floor(Math.random()*pool.length)]).join(' ');
      }
      function makeSequence(type, len){
        if(type === 'digits') return makeDigits(len);
        if(type === 'letters') return makeLetters(len);
        return makeWords(len);
      }

      function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
      function randDirection(){ return Math.random()<0.5 ? -1 : 1; }
      function clamp(val,min,max){ return Math.max(min, Math.min(max,val)); }

      function presentSequence(seq, speed){
        if (controller.timer) clearInterval(controller.timer);
        const parts = controller.type === 'words' ? seq.split(' ') : seq.split('');
        let i = 0;
        
        seqEl.textContent = '¬∑'; // Preparados
        seqEl.classList.remove('hidden');

        controller.timer = setInterval(() => {
          if (i < parts.length) {
            seqEl.textContent = parts[i]; // Mostrar √≠tem actual
            i++;
          } else {
            clearInterval(controller.timer);
            controller.timer = null;
            
            seqEl.textContent = '...'; // Ocultar √≠tem final
            setTimeout(() => {
              seqEl.classList.add('hidden');
              $('#spanInputGroup').classList.remove('hidden');
              respEl.value = '';
              respEl.focus();
            }, 500);
          }
        }, speed);
      }

      function updateKpis(){
        const total = state.span.trials.length;
        const correct = state.span.trials.filter(t => t.similarity === 1).length;
        const acc = total ? (correct / total * 100).toFixed(0) + '%' : '‚Äî';
        
        $('#kpiAcc').textContent = acc;
        $('#kpiSpan').textContent = state.span.estimate ? state.span.estimate.toFixed(1) : '‚Äî';
        
        const ch = state.chunk.results.length ? computeChunkAdvantage(state.chunk.results) : null;
        $('#kpiChunk').textContent = ch ? (ch > 0 ? '+' : '') + (ch * 100).toFixed(0) + '%' : '‚Äî';
      }

      function estimateSpan(){
        const correctTrials = state.span.trials.filter(t => t.similarity === 1);
        const correctLens = correctTrials.map(t => t.length);
        const maxCorrect = correctLens.length ? Math.max(...correctLens) : 0;
        
        const revs = controller.reversals.slice(-4);
        const revAvg = revs.length > 1 ? revs.reduce((a,b)=>a+b,0) / revs.length : 0;
        
        const est = Math.max(maxCorrect, revAvg);
        state.span.estimate = est > 0 ? est : null;
      }

      function startSpan(){
        if (controller.timer) clearInterval(controller.timer);
        controller = { 
          running: true, 
          index: 0, 
          total: parseInt($('#trials').value, 10), 
          len: 5, 
          reversals: [], 
          lastDir: null, 
          currentSeq: '', 
          type: $('#stimulus').value, 
          speed: parseInt($('#speed').value, 10), 
          timer: null 
        };
        state.span.trials = [];
        persist();
        
        totalEl.textContent = controller.total; 
        progressEl.textContent = '0';
        $('#spanStage').classList.remove('hidden');
        $('#spanInputGroup').classList.add('hidden');
        seqEl.classList.add('hidden');
        feedbackEl.textContent = '';
        
        feedbackLogEl.innerHTML = '';
        feedbackLogEl.classList.remove('hidden');
        
        nextTrial();
      }
      
      function nextTrial(){
        if(controller.index >= controller.total){
          feedbackEl.innerHTML = '<span class="success">Sesi√≥n terminada. Revisa tus resultados.</span>';
          estimateSpan(); persist(); updateKpis();
          controller.running = false;
          return;
        }
        
        $('#spanInputGroup').classList.add('hidden');
        controller.currentSeq = makeSequence(controller.type, controller.len);
        seqEl.textContent = '¬∑';
        feedbackEl.textContent = '';

        runCountdown(countdownEl, () => {
          presentSequence(controller.currentSeq, controller.speed);
        });
        
        controller.index++; 
        progressEl.textContent = String(controller.index);
      }

      respEl.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && controller.running && !controller.timer){
          const given = respEl.value.trim();
          const target = controller.currentSeq;
          
          const sim = getSimilarity(given, target);
          const correct = (sim === 1);
          
          const trial = { 
            length: controller.len, 
            type: controller.type, 
            similarity: sim, 
            correct,
            given, 
            target, 
            ts: Date.now() 
          };
          state.span.trials.push(trial);
          
          const dir = correct ? +1 : -1;
          if(controller.lastDir !== null && dir !== controller.lastDir){ 
            controller.reversals.push(controller.len); 
          }
          controller.lastDir = dir;
          controller.len = Math.max(3, controller.len + dir);
          
          persist();
          
          if (correct) {
            feedbackEl.innerHTML = '<span class="success">¬°Correcto!</span>';
          } else if (sim > 0.7) {
            feedbackEl.innerHTML = `<span class="warning">¬°Casi! (${(sim*100).toFixed(0)}% similitud)</span> <span class="detail">Era: ${escapeHtml(target)}</span>`;
          } else {
            feedbackEl.innerHTML = `<span class="error">Incorrecto (${(sim*100).toFixed(0)}%).</span> <span class="detail">Era: ${escapeHtml(target)}</span>`;
          }

          const attemptNum = state.span.trials.length;
          const icon = correct ? '‚úÖ' : (sim > 0.7 ? '‚ö†Ô∏è' : '‚ùå');
          const entry = document.createElement('div');
          entry.innerHTML = `
            <span>${attemptNum}.</span> 
            <span>L:${target.length}</span> 
            <span>${icon}</span> 
            <span class="${correct ? 'success' : 'error'}">${escapeHtml(given) || '(vac√≠o)'}</span> 
            <span class="detail">(Era: ${escapeHtml(target)})</span>
          `;
          feedbackLogEl.appendChild(entry);
          feedbackLogEl.scrollTop = feedbackLogEl.scrollHeight;
          
          setTimeout(nextTrial, correct ? 800 : 1200);
        }
      });

      resetBtn.addEventListener('click', () => {
        if (controller.timer) clearInterval(controller.timer);
        controller.running = false; 
        state.span.trials = []; 
        state.span.estimate = null; 
        controller.reversals = []; 
        persist();
        
        seqEl.textContent = '‚Äî'; 
        feedbackEl.textContent = ''; 
        progressEl.textContent = '0'; 
        totalEl.textContent = '0'; 
        respEl.value = '';
        $('#spanStage').classList.add('hidden');
        $('#spanInputGroup').classList.add('hidden');
        seqEl.classList.add('hidden');
        feedbackLogEl.classList.add('hidden'); // Ocultar log
        updateKpis();
      });
      
      startBtn.addEventListener('click', startSpan);

      // ------------------------- CHUNKING -------------------------
      const chunkDisplay = $('#chunkDisplay');
      const chunkResp = $('#chunkResponse');
      const startChunkBtn = $('#startChunk');
      const chunkTrialEl = $('#chunkTrial');
      const chunkTotalEl = $('#chunkTotal');
      const chunkFeedback = $('#chunkFeedback');

      let chunkCtrl = { index: 0, start: 0, scenario: 'letters', queue: [], current: null, total: 0, examples: [] };

      const chunkLibrary = {
        letters: [
          { raw: 'OTANUNESCOOMSFAOUE', grouped: 'OTAN-UNESCO-OMS-FAO-UE', label: 'Organismos internacionales' },
          { raw: 'FMIIBMBBCNASAONU', grouped: 'FMI-IBM-BBC-NASA-ONU', label: 'Siglas mixtas' },
          { raw: 'SEATRENFEAVEADIFINECO', grouped: 'SEAT-RENFE-AVE-ADIF-INECO', label: 'Transporte espa√±ol' },
          { raw: 'CSICESACERNISROCNES', grouped: 'CSIC-ESA-CERN-ISRO-CNES', label: 'Agencias cient√≠ficas' },
          { raw: 'DGTINEMECSEPEAEAT', grouped: 'DGT-INE-MEC-SEPE-AEAT', label: 'Instituciones p√∫blicas' },
          { raw: 'ACNURUNICEFCICRCAREOIM', grouped: 'ACNUR-UNICEF-CICR-CARE-OIM', label: 'Organizaciones humanitarias' },
          { raw: 'MITUOCUNEDUPVUAH', grouped: 'MIT-UOC-UNED-UPV-UAH', label: 'Universidades' },
          { raw: 'HTMLCSSJSJSONSQL', grouped: 'HTML-CSS-JS-JSON-SQL', label: 'Tecnolog√≠as web' },
          { raw: 'SATAHDMISSDRAMUSB', grouped: 'SATA-HDMI-SSD-RAM-USB', label: 'Tecnolog√≠a dom√©stica' },
          { raw: 'GMAILSLACKTEAMSZOOMMEET', grouped: 'GMAIL-SLACK-TEAMS-ZOOM-MEET', label: 'Herramientas digitales' },
          { raw: 'MADBCNROMPARLON', grouped: 'MAD-BCN-ROM-PAR-LON', label: 'Ciudades' },
          { raw: 'IBERIAVUELINGIAGRYANAIR', grouped: 'IBERIA-VUELING-IAG-RYANAIR', label: 'Aerol√≠neas' }
        ],
        phone: [
          { raw: '603123456789', grouped: '603-123-456-789', label: 'Segmentaci√≥n m√≥vil' },
          { raw: '91800506070', grouped: '91-800-50-60-70', label: 'Tel√©fono largo' },
          { raw: '96477221100', grouped: '964-77-22-11-00', label: 'Prefijo auton√≥mico' },
          { raw: '72255443388', grouped: '722-55-44-33-88', label: 'N√∫mero repetido' },
          { raw: '93411223344', grouped: '93-411-22-33-44', label: 'Prefijo Barcelona' },
          { raw: '95066077088', grouped: '950-66-07-70-88', label: 'Prefijo Almer√≠a' },
          { raw: '62399887766', grouped: '623-99-88-77-66', label: 'M√≥vil descendente' },
          { raw: '91000111222', grouped: '91-000-11-12-22', label: 'Capital con bloques' },
          { raw: '97644556677', grouped: '976-44-55-66-77', label: 'Prefijo Zaragoza' },
          { raw: '98512323445', grouped: '985-12-32-34-45', label: 'Prefijo Asturias' }
        ]
      };

      function shuffleCopy(arr){
        const copy = arr.slice();
        for(let i = copy.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i + 1));
          [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
      }

      function sampleExamples(arr, count){
        if(!arr.length) return [];
        return shuffleCopy(arr).slice(0, Math.min(count, arr.length));
      }

      function finalizeChunkQueue(selection){
        if(!selection.length) return { queue: [], examples: [] };
        const examples = selection.map((item, idx) => ({
          id: idx,
          raw: item.raw,
          grouped: item.grouped,
          label: item.label || `Ejemplo ${idx + 1}`
        }));
        const rawEntries = examples.map(ex => ({
          example: ex.id,
          phase: 0,
          version: 'raw',
          label: ex.label,
          text: ex.raw
        }));
        const groupedEntries = examples.map(ex => ({
          example: ex.id,
          phase: 1,
          version: 'grouped',
          label: ex.label,
          text: ex.grouped
        }));
        return { queue: [...rawEntries, ...groupedEntries], examples };
      }

      function buildCustomExamples(){
        const rawInput = ($('#customRaw').value || 'IBMSONYFBICNNUNESCO').trim();
        const groupedInput = ($('#customGrouped').value || 'IBM-SONY-FBI-CNN-UNESCO').trim();
        const splitter = /[\n;,|]+/;
        const rawList = rawInput.split(splitter).map(s => s.trim()).filter(Boolean);
        const groupedList = groupedInput.split(splitter).map(s => s.trim()).filter(Boolean);
        if(!rawList.length) rawList.push('IBMSONYFBICNNUNESCO');
        if(!groupedList.length) groupedList.push('IBM-SONY-FBI-CNN-UNESCO');
        const needed = Math.max(3, rawList.length, groupedList.length);
        const selected = [];
        for(let i = 0; i < needed && selected.length < 3; i++){
          selected.push({
            raw: rawList[i % rawList.length],
            grouped: groupedList[i % groupedList.length],
            label: `Personalizado ${i + 1}`
          });
        }
        while(selected.length < 3){
          selected.push({
            raw: rawList[selected.length % rawList.length],
            grouped: groupedList[selected.length % groupedList.length],
            label: `Personalizado ${selected.length + 1}`
          });
        }
        return finalizeChunkQueue(selected.slice(0, 3));
      }

      function buildChunkQueue(scenario){
        if(scenario === 'custom'){
          return buildCustomExamples();
        }
        const library = chunkLibrary[scenario] || [];
        const selection = sampleExamples(library, 3);
        if(selection.length){
          return finalizeChunkQueue(selection);
        }
        return finalizeChunkQueue(library.slice(0, 3));
      }

      function startChunk(){
        const scenario = $('#chunkScenario').value;
        const prepared = buildChunkQueue(scenario);
        chunkCtrl = { 
          index: 0, 
          start: 0, 
          scenario, 
          queue: prepared.queue, 
          current: null, 
          total: prepared.queue.length, 
          examples: prepared.examples 
        };
        state.chunk.results = []; // Reiniciar resultados de chunking
        persist();
        $('#chunkStage').classList.remove('hidden');
        $('#chunkInputGroup').classList.add('hidden');
        chunkDisplay.classList.add('hidden');
        chunkFeedback.textContent = '';
        const totalTrials = chunkCtrl.total || 0;
        chunkTrialEl.textContent = totalTrials ? '1' : '0';
        if(chunkTotalEl){
          chunkTotalEl.textContent = totalTrials ? String(totalTrials) : '0';
        }
        if(!chunkCtrl.total){
          chunkFeedback.innerHTML = '<span class="error">No hay ejemplos configurados para este escenario.</span>';
          return;
        }
        const first = chunkCtrl.queue[0];
        chunkFeedback.innerHTML = '<span class="muted">Empieza con una secuencia sin guiones.</span>';
        
        runCountdown(chunkCountdownEl, () => {
          presentChunk(first);
        });
      }

      function presentChunk(entry){
        chunkResp.value = ''; 
        chunkDisplay.textContent = entry.text;
        chunkDisplay.classList.remove('hidden');
        chunkCtrl.current = entry;
        
        setTimeout(() => { 
          chunkDisplay.classList.add('hidden');
          $('#chunkInputGroup').classList.remove('hidden');
          chunkResp.value = ''; 
          chunkResp.focus(); 
          chunkCtrl.start = performance.now(); 
        }, 2500);
      }

      function endChunkTrial(given){
        if(!chunkCtrl.current) return;
        const target = chunkCtrl.current.text;
        const sim = getSimilarity(given, target);
        const ok = (sim === 1);
        const rt = (performance.now() - chunkCtrl.start) / 1000;

        state.chunk.results.push({ 
          scenario: chunkCtrl.scenario, 
          phase: chunkCtrl.current.phase, 
          example: chunkCtrl.current.example,
          version: chunkCtrl.current.version,
          label: chunkCtrl.current.label,
          similarity: sim,
          ok, 
          rt, 
          target, 
          given 
        });
        persist();
        
        let feedbackMsg;
        if (ok) {
          feedbackMsg = '<span class="success">¬°Correcto!</span>';
        } else if (sim > 0.7) {
          feedbackMsg = `<span class="warning">¬°Casi! (${(sim*100).toFixed(0)}% similitud)</span>`;
        } else {
          feedbackMsg = `<span class="error">Incorrecto (${(sim*100).toFixed(0)}%).</span>`;
        }

        const descriptor = chunkCtrl.current.version === 'raw' ? 'sin guiones' : 'agrupada';
        chunkFeedback.innerHTML = `${feedbackMsg} <br><span class="muted">${chunkCtrl.current.label} (${descriptor}).</span>`;

        chunkCtrl.current = null;
        chunkCtrl.index += 1;

        if(chunkCtrl.index < chunkCtrl.total){
          const next = chunkCtrl.queue[chunkCtrl.index];
          chunkTrialEl.textContent = String(chunkCtrl.index + 1);
          chunkFeedback.innerHTML += next.version === 'raw'
            ? ' <br>Prep√°rate para otra secuencia sin guiones.'
            : ' <br>Ahora toca la versi√≥n agrupada con guiones.';
          $('#chunkInputGroup').classList.add('hidden');
          
          setTimeout(() => {
            runCountdown(chunkCountdownEl, () => {
              presentChunk(next);
            });
          }, 1200);

        } else {
          chunkFeedback.innerHTML += ' <br><span class="success">Comparaci√≥n completada. Revisa tus Resultados.</span>';
          updateKpis();
          populateChunkTable(); // Actualizar tabla al terminar
        }
      }

      chunkResp.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !$('#chunkStage').classList.contains('hidden')){
          if(!chunkCtrl.current) return;
          const given = chunkResp.value.trim();
          if(!given) return;
          endChunkTrial(given);
        }
      });

      startChunkBtn.addEventListener('click', startChunk);

      function computeChunkAdvantage(arr){
        if(!arr.length) return null;
        const byExample = {};
        arr.forEach(item => {
          if(typeof item.example === 'undefined') return;
          const key = item.example;
          byExample[key] = byExample[key] || { label: item.label };
          if(item.phase === 0){
            byExample[key].raw = item;
          } else if(item.phase === 1){
            byExample[key].grouped = item;
          }
        });
        const scores = Object.values(byExample)
          .filter(pair => pair.raw && pair.grouped)
          .map(pair => {
            const accGain = pair.grouped.similarity - pair.raw.similarity;
            const timeGain = (pair.raw.rt - pair.grouped.rt) / Math.max(pair.raw.rt, pair.grouped.rt, 0.01);
            return (0.6 * accGain + 0.4 * timeGain);
          });
        if(!scores.length){
          const last = arr.slice(-2);
          if(last.length < 2) return null;
          const raw = last.find(item => item.phase === 0) || last[0];
          const grouped = last.find(item => item.phase === 1) || last[last.length - 1];
          if(!raw || !grouped) return null;
          const accGain = grouped.similarity - raw.similarity;
          const timeGain = (raw.rt - grouped.rt) / Math.max(raw.rt, grouped.rt, 0.01);
          return (0.6 * accGain + 0.4 * timeGain);
        }
        const total = scores.reduce((sum, val) => sum + val, 0);
        return total / scores.length;
      }

      // ------------------------- RESULTADOS -------------------------
      const chartEl = $('#chart');
      
      // --- NUEVA: Funci√≥n para rellenar la tabla de Chunking ---
      function populateChunkTable() {
        const tableBody = $('#chunkTable tbody');
        if(!tableBody) return;
        if (!state.chunk.results.length) {
          tableBody.innerHTML = '<tr><td colspan="4" class="muted">Realiza el test de Chunking para ver resultados.</td></tr>';
          return;
        }

        const groupedByExample = {};
        state.chunk.results.forEach(item => {
          if(typeof item.example === 'undefined') return;
          const key = item.example;
          groupedByExample[key] = groupedByExample[key] || { label: item.label || `Ejemplo ${key + 1}` };
          if(item.phase === 0){
            groupedByExample[key].raw = item;
          } else if(item.phase === 1){
            groupedByExample[key].grouped = item;
          }
        });

        const order = Object.keys(groupedByExample).map(Number).sort((a, b) => a - b);
        if(!order.length){
          const legacy = state.chunk.results.slice(-2);
          if(legacy.length < 2){
            tableBody.innerHTML = '<tr><td colspan="4" class="muted">Realiza el test de Chunking para ver resultados.</td></tr>';
            return;
          }
          const rawLegacy = legacy[0].phase === 0 ? legacy[0] : legacy[1];
          const groupedLegacy = legacy[0].phase === 0 ? legacy[1] : legacy[0];
          const fallbackHtml = `<tr>
              <td><strong>Sin agrupar</strong></td>
              <td class="${rawLegacy.ok ? 'success' : 'error'}">${(rawLegacy.similarity * 100).toFixed(0)}%</td>
              <td>${rawLegacy.rt.toFixed(2)}s</td>
              <td><code>${escapeHtml(rawLegacy.given || '')}</code></td>
            </tr>
            <tr>
              <td><strong>Agrupado</strong></td>
              <td class="${groupedLegacy.ok ? 'success' : 'error'}">${(groupedLegacy.similarity * 100).toFixed(0)}%</td>
              <td>${groupedLegacy.rt.toFixed(2)}s</td>
              <td><code>${escapeHtml(groupedLegacy.given || '')}</code></td>
            </tr>`;
          tableBody.innerHTML = fallbackHtml;
          return;
        }

        let html = '';

        order.forEach((idx, pos) => {
          const bucket = groupedByExample[idx];
          const label = bucket.label || `Ejemplo ${pos + 1}`;
          html += `<tr><td colspan="4"><strong>${escapeHtml(label)}</strong></td></tr>`;

          if(bucket.raw){
            html += `<tr>
              <td><strong>Sin agrupar</strong></td>
              <td class="${bucket.raw.ok ? 'success' : 'error'}">${(bucket.raw.similarity * 100).toFixed(0)}%</td>
              <td>${bucket.raw.rt.toFixed(2)}s</td>
              <td><code>${escapeHtml(bucket.raw.given || '')}</code></td>
            </tr>`;
          } else {
            html += `<tr>
              <td><strong>Sin agrupar</strong></td>
              <td class="muted">‚Äî</td>
              <td>‚Äî</td>
              <td><code>‚Äî</code></td>
            </tr>`;
          }

          if(bucket.grouped){
            html += `<tr>
              <td><strong>Agrupado</strong></td>
              <td class="${bucket.grouped.ok ? 'success' : 'error'}">${(bucket.grouped.similarity * 100).toFixed(0)}%</td>
              <td>${bucket.grouped.rt.toFixed(2)}s</td>
              <td><code>${escapeHtml(bucket.grouped.given || '')}</code></td>
            </tr>`;
          } else {
            html += `<tr>
              <td><strong>Agrupado</strong></td>
              <td class="muted">‚Äî</td>
              <td>‚Äî</td>
              <td><code>‚Äî</code></td>
            </tr>`;
          }
        });

        tableBody.innerHTML = html;
      }
      
      function drawChart(){
        const ctx = chartEl.getContext('2d');
        ctx.clearRect(0,0,chartEl.width,chartEl.height);
        const w = chartEl.clientWidth, h = chartEl.clientHeight;
        
        const styles = getComputedStyle(document.documentElement);
        const colorBorder = styles.getPropertyValue('--border').trim();
        const colorMuted = styles.getPropertyValue('--muted').trim();
        const colorBrand = styles.getPropertyValue('--brand').trim() || '#007bff';
        
        const pad = 40;
        ctx.strokeStyle = colorBorder;
        ctx.fillStyle = colorMuted;
        ctx.font = '12px Inter';
        
        ctx.beginPath();
        ctx.moveTo(pad, pad); ctx.lineTo(pad, h - pad); ctx.lineTo(w - pad, h - pad);
        ctx.stroke();
        
        ctx.textAlign = 'left';
        ctx.fillText('Precisi√≥n (%)', pad, pad - 10);
        ctx.textAlign = 'center';
        ctx.fillText('Longitud de Secuencia', w / 2, h - pad + 25);
        ctx.textAlign = 'right';
        ctx.fillText('100%', pad - 8, pad + 5);
        ctx.fillText('0%', pad - 8, h - pad);

        const trials = state.span.trials;
        if(!trials.length) return;

        const groups = {};
        trials.forEach(t => { 
          groups[t.length] = groups[t.length] || {n:0, ok:0}; 
          groups[t.length].n++; 
          if(t.similarity === 1) groups[t.length].ok++; 
        });
        
        const lengths = Object.keys(groups).map(n => +n).sort((a,b) => a-b);
        if(!lengths.length) return;
        
        const minL = Math.min(...lengths);
        const maxL = Math.max(...lengths);
        const numBars = (maxL - minL) + 1;
        const xStep = (w - 2 * pad) / Math.max(numBars, 1);
        
        for (let i = 0; i <= numBars; i++) {
          const L = minL + i;
          const group = groups[L];
          const x = pad + i * xStep;
          const barW = Math.max(2, xStep * 0.7);
          
          if (group) {
            const acc = group.ok / group.n;
            const barH = acc * (h - 2 * pad);
            ctx.fillStyle = `${colorBrand}B3`; // 70% opacidad
            ctx.fillRect(x + (xStep - barW) / 2, h - pad - barH, barW, barH);
          }
          
          ctx.fillStyle = colorMuted;
          ctx.textAlign = 'center';
          ctx.fillText(String(L), x + xStep / 2, h - pad + 14);
        }
      }

      function exportCSV(){
        const rows = [];
        rows.push(['test','ts','tipo','longitud','similitud','correcto','objetivo','respuesta','rt_s','escenario','fase']);
        state.span.trials.forEach(t => {
          rows.push(['span', new Date(t.ts).toISOString(), t.type, t.length, t.similarity.toFixed(3), t.correct?'1':'0', t.target, t.given, '', '', '']);
        });
        state.chunk.results.forEach(c => {
          rows.push(['chunk', new Date().toISOString(), '', '', c.similarity.toFixed(3), c.ok?'1':'0', c.target, c.given, c.rt.toFixed(3), c.scenario, String(c.phase)]);
        });
        const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
        download('resultados_miller_lab.csv', csv, 'text/csv');
      }

      function clearAll(){
        if(confirm('¬øSeguro que deseas borrar todos los datos guardados en este navegador?')){
          localStorage.removeItem(storeKey);
          state.span = {trials:[], estimate:null}; 
          state.chunk = {results:[]};
          updateKpis(); 
          drawChart();
          populateChunkTable(); // <-- Limpiar tabla
        }
      }

      $('#exportCSV').addEventListener('click', exportCSV);
      $('#clearAll').addEventListener('click', clearAll);

      // Init
      updateKpis();
      drawChart();
      populateChunkTable(); // <-- Rellenar al cargar
    })();
  </script>
</body>
</html>
