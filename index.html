<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Miller Lab: 7Â±2 y Chunking</title>
Â  <meta name="description" content="Laboratorio interactivo para experimentar con el NÃºmero MÃ¡gico 7Â±2 y el Chunking.">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: #f8f9fa; Â  Â  Â  /* Un gris muy claro */
Â  Â  Â  --card: #ffffff; Â  Â  Â /* Blanco puro */
Â  Â  Â  --text: #212529; Â  Â  Â /* Negro suave */
Â  Â  Â  --muted: #6c757d; Â  Â  /* Gris para texto secundario */
Â  Â  Â  --border: #e9ecef; Â  Â /* Borde sutil */
Â  Â  Â  --brand: #007bff; Â  Â  /* Azul primario */
Â  Â  Â  --ok: #28a745; Â  Â  Â  Â /* Verde */
Â  Â  Â  --warn: #fd7e14; Â  Â  Â /* Naranja */
Â  Â  Â  --bad: #dc3545; Â  Â  Â  /* Rojo */
Â  Â  Â  --radius: 12px;
Â  Â  Â  --shadow: 0 4px 12px rgba(0,0,0,.04);
Â  Â  }
Â  Â  * { box-sizing: border-box; }
Â  Â  html { font-size: 16px; }
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
Â  Â  Â  background-color: var(--bg);
Â  Â  Â  color: var(--text);
Â  Â  Â  line-height: 1.6;
Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  -moz-osx-font-smoothing: grayscale;
Â  Â  }
Â  Â Â 
Â  Â  .wrap {
Â  Â  Â  max-width: 800px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding: 1.5rem 1rem;
Â  Â  }

Â  Â  /* --- Cabecera y NavegaciÃ³n --- */
Â  Â  header {
Â  Â  Â  padding: 1rem 0;
Â  Â  Â  border-bottom: 1px solid var(--border);
Â  Â  Â  background: rgba(255,255,255,.7);
Â  Â  Â  backdrop-filter: blur(8px);
Â  Â  Â  position: sticky;
Â  Â  Â  top: 0;
Â  Â  Â  z-index: 10;
Â  Â  }
Â  Â  header .wrap {
Â  Â  Â  padding-top: 0; padding-bottom: 0;
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 1rem;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  margin: 0;
Â  Â  }
Â  Â  h1 .muted {
Â  Â  Â  font-weight: 400;
Â  Â  Â  color: var(--muted);
Â  Â  }
Â  Â  nav {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.5rem;
Â  Â  }
Â  Â  .tab {
Â  Â  Â  display: inline-block;
Â  Â  Â  font: inherit;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  padding: 0.5rem 0.8rem;
Â  Â  Â  border: 1px solid transparent;
Â  Â  Â  border-radius: 99px;
Â  Â  Â  background: none;
Â  Â  Â  color: var(--muted);
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  .tab:hover {
Â  Â  Â  background: var(--bg);
Â  Â  Â  color: var(--text);
Â  Â  }
Â  Â  .tab.active {
Â  Â  Â  background: var(--brand);
Â  Â  Â  color: #fff;
Â  Â  Â  border-color: var(--brand);
Â  Â  }

Â  Â  /* --- Contenido Principal y Tarjetas --- */
Â  Â  main { padding-top: 2rem; }
Â  Â  .card {
Â  Â  Â  background: var(--card);
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  padding: 1.5rem 1.75rem;
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  }
Â  Â  h2 {
Â  Â  Â  font-size: 1.75rem;
Â  Â  Â  margin: 0 0 1rem 0;
Â  Â  }
Â  Â  p { margin: 0 0 1rem 0; }
Â  Â  .hidden { display: none; }
Â  Â Â 
Â  Â  /* --- Controles (Selects, Botones) --- */
Â  Â  .controls {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 0.75rem;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  background: var(--bg);
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  margin-top: 1.5rem;
Â  Â  }
Â  Â  .control-group {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .control-group label {
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: var(--muted);
Â  Â  Â  margin-bottom: 0.25rem;
Â  Â  }
Â  Â  select, input[type="text"], input[type="number"], button {
Â  Â  Â  font: inherit;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  padding: 0.6rem 0.8rem;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  border-radius: 8px;
Â  Â  Â  background: var(--card);
Â  Â  Â  color: var(--text);
Â  Â  Â  outline-color: var(--brand);
Â  Â  }
Â  Â  input[type="number"] { width: 70px; }
Â  Â  button {
Â  Â  Â  cursor: pointer;
Â  Â  Â  background: #f1f3f5; /* gris claro */
Â  Â  Â  color: var(--text);
Â  Â  Â  font-weight: 600;
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  transition: all 0.1s ease;
Â  Â  }
Â  Â  button:hover {
Â  Â  Â  border-color: #ced4da;
Â  Â  }
Â  Â  button:active {
Â  Â  Â  transform: scale(0.98);
Â  Â  }
Â  Â  button.primary {
Â  Â  Â  background: var(--brand);
Â  Â  Â  color: #fff;
Â  Â  Â  border-color: var(--brand);
Â  Â  }
Â  Â  button.primary:hover {
Â  Â  Â  border-color: #0056b3;
Â  Â  Â  background: #0056b3;
Â  Â  }
Â  Â  .w100 { width: 100%; }

Â  Â  /* --- Elementos de la App --- */
Â  Â  .stage {
Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  padding-top: 1.5rem;
Â  Â  Â  border-top: 1px solid var(--border);
Â  Â  }
Â  Â Â 
Â  Â  /* 1. Cuenta atrÃ¡s (dibujo) */
Â  Â  .countdown-timer {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 1rem;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  height: 100px;
Â  Â  }
Â  Â  .countdown-timer span {
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  background: var(--border);
Â  Â  Â  opacity: 0;
Â  Â  Â  animation: countdown-dot 1.2s ease-in-out both;
Â  Â  }
Â  Â  .countdown-timer.animate span:nth-child(1) { animation-delay: 0s; }
Â  Â  .countdown-timer.animate span:nth-child(2) { animation-delay: 1.2s; }
Â  Â  .countdown-timer.animate span:nth-child(3) { animation-delay: 2.4s; }
Â  Â Â 
Â  Â  @keyframes countdown-dot {
Â  Â  Â  0%, 100% { opacity: 0; transform: scale(0.8); }
Â  Â  Â  30%, 70% { opacity: 1; transform: scale(1); }
Â  Â  }

Â  Â  /* 2. Display de Secuencia */
Â  Â  .sequence {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  letter-spacing: 2px;
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 1.5rem;
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  background: var(--bg);
Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  min-height: 80px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-variant-numeric: tabular-nums;
Â  Â  }
Â  Â Â 
Â  Â  /* 3. Feedback */
Â  Â  .progress {
Â  Â  Â  text-align: right;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  color: var(--muted);
Â  Â  Â  margin: 0.5rem 0;
Â  Â  }
Â  Â  .feedback {
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  min-height: 1.5em;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  }
Â  Â  .feedback .success { color: var(--ok); font-weight: 600; }
Â  Â  .feedback .warning { color: var(--warn); font-weight: 600; }
Â  Â  .feedback .error { color: var(--bad); font-weight: 600; }
Â  Â  .feedback .detail {
Â  Â  Â  color: var(--muted);
Â  Â  Â  font-family: monospace;
Â  Â  Â  font-size: 0.85rem;
Â  Â  }
Â  Â Â 
Â  Â  /* 4. Resultados (KPIs y GrÃ¡fico) */
Â  Â  .kpi-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  Â  Â  gap: 1rem;
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  }
Â  Â  .kpi-box .label {
Â  Â  Â  font-size: 0.9rem;
Â  	 color: var(--muted);
Â  Â  }
Â  Â  .kpi-box .value {
Â  Â  Â  font-size: 1.75rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  line-height: 1.2;
Â  Â  }
Â  Â  canvas {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 250px;
Â  Â  Â  background: var(--bg);
Â  Â  Â  border-radius: var(--radius);
Â  Â  Â  border: 1px solid var(--border);
Â  Â  }
Â  Â Â 
Â  Â  /* --- Footer --- */
Â  Â  footer {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 2rem 1rem;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  color: var(--muted);
Â  Â  Â  border-top: 1px solid var(--border);
Â  Â  Â  margin-top: 2rem;
Â  Â  }
Â  Â  footer a {
Â  Â  Â  color: var(--brand);
Â  Â  Â  text-decoration: none;
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  footer a:hover {
Â  Â  Â  text-decoration: underline;
Â  Â  }
Â  Â  .kofi-button {
Â  Â  Â  display: inline-block;
Â  Â  Â  background: #fd7e14;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  Â  border-radius: 99px;
Â  Â  Â  text-decoration: none;
Â  Â  Â  font-weight: 600;
Â  Â  Â  margin-left: 0.5rem;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  box-shadow: 0 2px 8px rgba(253, 126, 20, .3);
Â  Â  }
Â  Â  .kofi-button:hover {
Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  box-shadow: 0 4px 12px rgba(253, 126, 20, .4);
Â  Â  }
Â  </style>
</head>
<body>

Â  <header>
Â  Â  <div class="wrap">
Â  Â  Â  <h1>Miller <span class="muted">Lab</span></h1>
Â  Â  Â  <nav aria-label="Secciones">
Â  Â  Â  Â  <button class="tab active" data-tab="intro">Inicio</button>
Â  Â  Â  Â  <button class="tab" data-tab="span">7Â±2</button>
Â  Â  Â  Â  <button class="tab" data-tab="chunk">Chunking</button>
Â  Â  Â  Â  <button class="tab" data-tab="result">Resultados</button>
Â  Â  Â  </nav>
Â  Â  </div>
Â  </header>

Â  <main class="wrap">

Â  Â  <section id="intro">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>Bienvenido al Laboratorio Miller</h2>
Â  Â  Â  Â  <p>
Â  Â  Â  Â  Â  Esta es una herramienta simple para explorar dos conceptos clave de la psicologÃ­a cognitiva descritos por George A. Miller:
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  <li><strong>NÃºmero MÃ¡gico 7Â±2:</strong> Mide el lÃ­mite de tu memoria a corto plazo (span de memoria).</li>
Â  Â  Â  Â  Â  <li><strong>Chunking:</strong> Comprueba cÃ³mo agrupar la informaciÃ³n en "chunks" (trozos) con significado te permite superar ese lÃ­mite.</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  Â  <p>Los datos se guardan solo en tu navegador. Â¡Empieza cuando quieras!</p>
Â  Â  Â  Â  <div class="controls" style="background: none; padding-left: 0;">
Â  Â  Â  Â  Â  <button class="primary" data-go="span">Empezar Test 7Â±2</button>
Â  Â  Â  Â  Â  <button data-go="chunk">Ir a Chunking</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <section id="span" class="hidden">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>Experimento: NÃºmero mÃ¡gico 7 Â± 2</h2>
Â  Â  Â  Â  <p>VerÃ¡s una secuencia de Ã­tems, uno por uno. Cuando termine, escrÃ­bela <strong>en el orden exacto</strong>. La longitud se ajustarÃ¡ automÃ¡ticamente segÃºn tus aciertos.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  <div class="control-group">
Â  Â  Â  Â  Â  Â  <label for="stimulus">EstÃ­mulo</label>
Â  Â  Â  Â  Â  Â  <select id="stimulus">
Â  Â  Â  Â  Â  Â  Â  <option value="digits">DÃ­gitos (0â€“9)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="letters">Letras (Aâ€“Z)</option>
Â  Â  Â  Â  Â  Â  	<option value="words">Palabras cortas</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="control-group">
Â  Â  Â  Â  Â  Â  <label for="speed">Velocidad</label>
Â  Â  Â  Â  Â  Â  <select id="speed">
Â  Â  Â  Â  Â  Â  Â  <option value="1000">Lenta (1s/Ã­tem)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="750" selected>Media (0.75s/Ã­tem)</option>
Â  	 Â  Â  Â  Â  Â  <option value="500">RÃ¡pida (0.5s/Ã­tem)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="control-group">
Â  Â  Â  Â  Â  Â  <label for="trials">Intentos</label>
Â  Â  Â  Â  Â  Â  <input id="trials" type="number" min="6" max="20" value="12" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button id="startSpan" class="primary">Iniciar</button>
Â  Â  Â  Â  Â  <button id="resetSpan" title="Borrar datos de esta sesiÃ³n">Reiniciar</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="spanStage" class="stage hidden">
Â  Â  Â  Â  Â  <div id="countdown" class="countdown-timer">
Â  Â  Â  Â  Â  	<span></span><span></span><span></span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div id="sequence" class="sequence hidden" aria-live="polite">â€”</div>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div id="spanInputGroup" class="hidden">
Â  Â  Â  Â  Â  	<input id="response" type="text" autocomplete="off" class="w100" placeholder="Escribe la secuencia y pulsa Enter" />
Â  Â  Â  Â  Â  	<div class="progress"><span id="progress">0</span> / <span id="total">0</span> intentos</div>
Â  Â  Â  Â  Â  	<div id="feedback" class="feedback"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  	<section id="chunk" class="hidden">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h2>Experimento: Chunking (agrupamiento)</h2>
Â  Â  Â  Â  <p>CompararÃ¡s tu recuerdo de la misma informaciÃ³n presentada de dos formas: primero sin estructura y luego agrupada en "chunks" con significado.</p>

Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  <div class="control-group">
Â  Â  Â  Â  Â  	<label for="chunkScenario">Escenario</label>
Â  Â  Â  Â  Â  	<select id="chunkScenario">
Â  Â  Â  Â  Â  	  <option value="letters" selected>Letras vs. Siglas</option>
Â  Â  Â  Â  Â  	  <option value="phone">NÃºmero largo vs. TelÃ©fono</option>
Â  Â  Â  Â  Â  	  <option value="custom">Personalizado</option>
Â  Â  Â  Â  Â  	</select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button id="startChunk" class="primary">Iniciar comparaciÃ³n</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <details class="mt16">
Â  	 Â  Â  Â  <summary style="color: var(--muted); cursor: pointer; font-size: 0.9rem;">Configurar texto personalizado</summary>
Â  	 Â  Â  Â  <div class="controls" style="margin-top: 0.5rem;">
Â  Â  Â  Â  Â  	  <div class="control-group w100">
Â  Â  Â  Â  Â  	 	 <label for="customRaw">Texto sin agrupar</label>
Â  Â  Â  Â  Â  	 	 <input id="customRaw" class="w100" type="text" value="IBMSONYFBICNNUNESCO" />
Â  Â  Â  Â  Â  	  </div>
Â  Â  Â  Â  Â  	  <div class="control-group w100">
Â  Â  Â  Â  Â  		  <label for="customGrouped">Texto agrupado (usa espacios/guiones)</label>
Â  Â  Â  Â  Â  		  <input id="customGrouped" class="w100" type="text" value="IBM-SONY-FBI-CNN-UNESCO" />
Â  Â  Â  Â  Â  	  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>

Â  Â  	  <div id="chunkStage" class="stage hidden">
Â  	 Â  Â  Â  <div id="chunkCountdown" class="countdown-timer">
Â  	 	 Â  Â  Â  <span></span><span></span><span></span>
Â  	 	 Â  Â  </div>
Â  	 	 Â  Â Â 
Â  	 	 Â  Â  <div id="chunkDisplay" class="sequence hidden">â€”</div>
Â  	 	 Â  Â Â 
Â  	 	 Â  Â  <div id="chunkInputGroup" class="hidden">
Â  	 	 Â  Â  Â  <input id="chunkResponse" type="text" class="w100" placeholder="Escribe lo que recuerdes y pulsa Enter" />
Â  	 	 Â  Â  Â  <div class="progress">Ensayo <span id="chunkTrial">1</span> / 2</div>
Â  	 	 Â  Â  Â  <div id="chunkFeedback" class="feedback"></div>
Â  	 	 Â  Â  </div>
Â  	 	  </div>
Â  Â    </div>
Â    </section>

Â  Â  <section id="result" class="hidden">
Â  Â    <div class="card">
Â  Â  Â  Â  <h2>Tus Resultados</h2>
Â  Â  Â  Â  <div class="kpi-grid">
Â  Â  Â  Â    <div class="kpi-box">
Â  Â  Â  Â  Â  Â  <div class="label">Span Estimado</div>
Â  Â  Â  Â  Â  Â  <div class="value" id="kpiSpan">â€”</div>
Â  Â  Â  Â    </div>
Â  Â  Â  Â    <div class="kpi-box">
Â  Â  Â  Â  Â  Â  <div class="label">PrecisiÃ³n (Span)</div>
Â  Â  Â  Â  Â  	<div class="value" id="kpiAcc">â€”</div>
Â  Â  Â  Â    </div>
Â  Â  Â  Â    <div class="kpi-box">
Â  Â  Â  Â  Â  Â  <div class="label">Ventaja Chunking</div>
Â  Â  Â  Â  Â  Â  <div class="value" id="kpiChunk">â€”</div>
Â  Â  Â  Â    </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <canvas id="chart"></canvas>
Â  Â  Â  Â  <p style="font-size: 0.9rem; color: var(--muted); text-align: center; margin-top: 0.5rem;">GrÃ¡fico: Tasa de acierto por longitud de secuencia (Test 7Â±2).</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="controls" style="margin-top: 1.5rem;">
Â  	 Â  Â  Â  <button id="exportCSV">Exportar CSV</button>
Â  	 Â  	 Â  <button id="clearAll" title="Borrar todo lo guardado">Borrar todos los datos</button>
Â  	 	 </div>
Â  	  </div>
Â    </section>
Â  </main>

Â  <footer>
Â  Â  <div class="wrap" style="padding: 0;">
Â  	 Â  DiseÃ±ado por <a href="https://jlmirall.es" target="_blank" rel="noopener noreferrer">JosÃ© Luis Miralles Bono</a>.
Â  	 Â  <br>
Â  	 Â  Si te ha gustado, puedes invitarme a unaÂ 
Â  	 Â  <a href="https://ko-fi.com/miralles" class="kofi-button" target="_blank" rel="noopener noreferrer">Horchata ðŸ¥¤</a>
Â    </div>
Â  </footer>

Â  <script>
Â  Â  (function(){
Â  Â  Â  const $ = sel => document.querySelector(sel);
Â  	 Â  const $$ = sel => Array.from(document.querySelectorAll(sel));

Â  Â  Â  // --- Estado y Persistencia ---
Â  	 Â  const state = {
Â  	 Â  Â  span: { trials: [], estimate: null },
Â  	 Â  	 chunk: { results: [] }
Â  Â  Â  };
Â  	 Â  const storeKey = 'miller-lab-v2-storage';
Â  	 Â  try { const saved = JSON.parse(localStorage.getItem(storeKey)); if(saved){ Object.assign(state, saved); } } catch(e){}
Â  	 Â  const persist = () => localStorage.setItem(storeKey, JSON.stringify(state));

Â  	 Â  // --- NavegaciÃ³n ---
Â  	 Â  function show(tab){
Â  	 Â  	 $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
Â  	 Â  	 ['intro','span','chunk','result'].forEach(id=>{
Â  	 Â  Â  	 const el = document.getElementById(id);
Â  	 Â  Â  	 if(el) el.classList.toggle('hidden', id!==tab);
Â  	 Â  	 });
Â  	 Â  	 if(tab==='result') drawChart();
Â  	 Â  }
Â  	 Â  $$('.tab').forEach(t=>t.addEventListener('click', ()=>show(t.dataset.tab)));
Â  	 Â  $$('#intro [data-go]').forEach(b=>b.addEventListener('click', ()=>show(b.dataset.go)));

Â  	 Â  // --- Utilidades ---
Â  	 Â  function normalize(s){ return s.replace(/[\s-]+/g,'').toUpperCase(); }
Â  	 Â  function escapeHtml(str){ return str.replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }
Â  	 Â Â 
Â  	 Â  /**
Â  	 Â  Â * Calcula la distancia de Levenshtein (coste de ediciÃ³n) entre dos strings.
Â  	 Â  Â * Â¡NUEVA FUNCIONALIDAD!
Â  	 Â  Â */
Â  	 Â  function levenshtein(a, b) {
Â  	 Â  	 if (a.length === 0) return b.length;
Â  	 	 Â  if (b.length === 0) return a.length;
Â  	 Â  	 const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
Â  	 Â  	 for (let i = 0; i <= a.length; i++) { matrix[0][i] = i; }
Â  	 	 Â  for (let j = 0; j <= b.length; j++) { matrix[j][0] = j; }
Â  	 	 Â  for (let j = 1; j <= b.length; j++) {
Â  	 Â  Â  	 for (let i = 1; i <= a.length; i++) {
Â  	 Â  Â  	 	 const cost = a[i - 1] === b[j - 1] ? 0 : 1;
Â  	 	 Â  Â  	 matrix[j][i] = Math.min(
Â  	 Â  	 Â  	 	 matrix[j][i - 1] + 1, Â  	 	// Deletion
Â  	 	 Â  Â  	 	 matrix[j - 1][i] + 1, Â  	 	// Insertion
Â  	 	 Â  Â  	 	 matrix[j - 1][i - 1] + cost // Substitution
Â  	 	 Â  Â  	 );
Â  	 	 Â  Â  }
Â  	 	 Â  }
Â  	 	 Â  return matrix[b.length][a.length];
Â  Â  Â  }

Â  	 Â  /**
Â  	 Â  Â * Calcula la similitud basada en Levenshtein.
Â  	 Â  Â * Devuelve un valor entre 0 (nada similar) y 1 (idÃ©ntico).
Â  	 Â  Â */
Â  	 Â  function getSimilarity(a, b) {
Â  	 Â  	 const normA = normalize(a);
Â  	 	 Â  const normB = normalize(b);
Â  	 	 Â  const maxLen = Math.max(normA.length, normB.length);
Â  	 	 Â  if (maxLen === 0) return 1;
Â  	 	 Â  const dist = levenshtein(normA, normB);
Â  	 	 Â  return 1 - (dist / maxLen);
Â  	 Â  }
Â  	 Â Â 
Â  	 Â  function download(filename, data, type){
Â  	 Â  	 const blob = new Blob([data], {type});
Â  	 	 Â  const url = URL.createObjectURL(blob);
Â  	 	 Â  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
Â  	 Â  }
Â  	 Â Â 
Â  	 Â  // --- Cuenta atrÃ¡s Visual ---
Â  	 Â  const countdownEl = $('#countdown');
Â  	 Â  const chunkCountdownEl = $('#chunkCountdown');
Â  	 Â Â 
Â  	 Â  function runCountdown(el, callback) {
Â  	 Â  	 el.classList.remove('hidden');
Â  	 	 Â  el.classList.add('animate');
Â  	 	 Â  // DuraciÃ³n total = 3 dots * 1.2s/dot = 3.6s
Â  	 	 Â  // + un pequeÃ±o buffer
Â  	 	 Â  setTimeout(() => {
Â  	 	 Â  Â  el.classList.remove('animate');
Â  	 	 Â  Â  	 el.classList.add('hidden');
Â  	 	 Â  Â  	 callback();
Â  	 	 Â  }, 3800);
Â  	 Â  }

Â  	 Â  // ------------------------- 7Â±2 -------------------------
Â  	 Â  const seqEl = $('#sequence');
Â  	 Â  const respEl = $('#response');
Â  	 Â  const startBtn = $('#startSpan');
Â  	 Â  const resetBtn = $('#resetSpan');
Â  	 Â  const progressEl = $('#progress');
Â  	 Â  const totalEl = $('#total');
Â  	 Â  const feedbackEl = $('#feedback');

Â  	 Â  let controller = {
Â  	 Â  	 running: false,
Â  	 Â  	 index: 0,
Â  	 	 Â  total: 12,
Â  	 	 Â  len: 5,
Â  	 	 Â  reversals: [],
Â  	 	 Â  lastDir: null,
Â  	 	 Â  currentSeq: '',
Â  	 	 Â  type: 'digits',
Â  	 	 Â  speed: 750,
Â  	 	 Â  timer: null
Â  	 Â  };

Â  	 Â  function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
Â  	 Â  function genItem(type){
Â  	 Â  	 if(type==='digits') return String(Math.floor(Math.random()*10));
Â  	 	 Â  if(type==='letters') return String.fromCharCode(65 + Math.floor(Math.random()*26));
Â  	 	 Â  if(type==='words'){
Â  	 	 Â  Â  const pool = ['sol','mar','pan','luz','voz','red','sal','tÃ©','gas','pie','vez','fin','flor','casa','lago','tren','vino'];
Â  	 	 Â  Â  	 return randFrom(pool);
Â  	 	 Â  }
Â  	 	 Â  return '?';
Â  	 Â  }
Â  	 Â  function makeSequence(type,len){
Â  	 	 Â  const items=[];Â 
Â  	 	 Â  while(items.length<len){ items.push(genItem(type)); }
Â  	 	 Â  // Para palabras, separar por espacio; para letras/dÃ­gitos, sin espacios
Â  	 	 Â  return items.join(type === 'words' ? ' ' : '');
Â  	 Â  }

Â  	 Â  function presentSequence(seq, speed){
Â  	 Â  	 if (controller.timer) clearInterval(controller.timer);
Â  	 	 Â  const parts = seq.split(controller.type === 'words' ? ' ' : '');
Â  	 	 Â  let i = 0;
Â  	 	 Â Â 
Â  	 	 Â  seqEl.textContent = 'Â·'; // Preparados
Â  	 	 Â  seqEl.classList.remove('hidden');

Â  	 	 Â  controller.timer = setInterval(() => {
Â  	 	 Â  Â  if (i < parts.length) {
Â  	 	 Â  	 Â  seqEl.textContent = parts[i]; // Mostrar Ã­tem actual
Â  	 	 Â  	 Â  i++;
Â  	 	 Â  Â  } else {
Â  	 	 Â  	 Â  clearInterval(controller.timer);
Â  	 	 Â  	 Â  controller.timer = null;
Â  	 	 Â  	 Â  setTimeout(() => {
Â  	 	 Â  	 Â  	 seqEl.classList.add('hidden');
Â  	 	 	 Â  Â  	 	 $('#spanInputGroup').classList.remove('hidden');
Â  	 	 	 Â  Â  	 	 respEl.value = '';
Â  	 	 	 	 Â  Â  	 respEl.focus();
Â  	 	 	 Â  	 Â  }, speed);Â 
Â  	 	 	 Â  Â  }
Â  	 	 Â  }, speed);
Â  	 Â  }

Â  	 Â  function updateKpis(){
Â  	 Â  	 const total = state.span.trials.length;
Â  	 Â  	 const correct = state.span.trials.filter(t => t.similarity === 1).length;
Â  	 	 Â  const acc = total ? (correct / total * 100).toFixed(0) + '%' : 'â€”';
Â  	 	 Â Â 
Â  	 	 Â  $('#kpiAcc').textContent = acc;
Â  	 	 Â  $('#kpiSpan').textContent = state.span.estimate ? state.span.estimate.toFixed(1) : 'â€”';
Â  	 	 Â Â 
Â  	 	 Â  const ch = state.chunk.results.length ? computeChunkAdvantage(state.chunk.results) : null;
Â  	 	 Â  $('#kpiChunk').textContent = ch ? (ch > 0 ? '+' : '') + (ch * 100).toFixed(0) + '%' : 'â€”';
Â  	 Â  }

Â  	 Â  function estimateSpan(){
Â  	 Â  	 const correctTrials = state.span.trials.filter(t => t.similarity === 1);
Â  	 	 Â  const correctLens = correctTrials.map(t => t.length);
Â  	 	 Â  const maxCorrect = correctLens.length ? Math.max(...correctLens) : 0;
Â  	 	 Â Â 
Â  	 	 Â  // Media de las Ãºltimas 3-4 reversiones
Â  	 	 Â  const revs = controller.reversals.slice(-4);
Â  	 	 Â  const revAvg = revs.length > 1 ? revs.reduce((a,b)=>a+b,0) / revs.length : 0;
Â  	 	 Â Â 
Â  	 	 Â  // El span es el mÃ¡ximo entre el pico de acierto y la media de reversiones
Â  	 	 Â  const est = Math.max(maxCorrect, revAvg);
Â  	 	 Â  state.span.estimate = est > 0 ? est : null;
Â  	 Â  }

Â  	 Â  function startSpan(){
Â  	 	 Â  if (controller.timer) clearInterval(controller.timer);
Â  	 	 Â  controller = {Â 
Â  	 	 Â  	 running: true,Â 
Â  	 	 	 Â  index: 0,Â 
Â  	 	 	 Â  total: parseInt($('#trials').value, 10),Â 
Â  	 	 	 Â  len: 5,Â 
Â  	 	 	 Â  reversals: [],Â 
Â  	 	 	 Â  lastDir: null,Â 
Â  	 	 	 Â  currentSeq: '',Â 
Â  	 	 	 Â  type: $('#stimulus').value,Â 
Â  	 	 	 Â  speed: parseInt($('#speed').value, 10),Â 
Â  	 	 	 Â  timer: nullÂ 
Â  	 Â  	 };
Â  	 	 Â  state.span.trials = [];
Â  	 	 Â  persist();
Â  	 	 Â Â 
Â  	 	 Â  totalEl.textContent = controller.total;Â 
Â  	 	 Â  progressEl.textContent = '0';
Â  	 	 Â  $('#spanStage').classList.remove('hidden');
Â  	 	 Â  $('#spanInputGroup').classList.add('hidden');
Â  	 	 Â  seqEl.classList.add('hidden');
Â  	 	 Â  feedbackEl.textContent = '';
Â  	 	 Â Â 
Â  	 	 Â  nextTrial();
Â  	 Â  }
Â  	 Â Â 
Â  	 Â  function nextTrial(){
Â  	 Â  	 if(controller.index >= controller.total){
Â  	 	 Â  Â  feedbackEl.innerHTML = '<span class="success">SesiÃ³n terminada. Revisa tus resultados.</span>';
Â  	 	 Â  Â  	 estimateSpan(); persist(); updateKpis();
Â  	 	 Â  Â  	 controller.running = false;
Â  	 	 Â  Â  	 return;
Â  	 	 Â  }
Â  	 	 Â Â 
Â  	 	 Â  $('#spanInputGroup').classList.add('hidden');
Â  	 	 Â  controller.currentSeq = makeSequence(controller.type, controller.len);
Â  	 	 Â  seqEl.textContent = 'Â·';
Â  	 	 Â  feedbackEl.textContent = '';

Â  	 	 Â  // Empezar cuenta atrÃ¡s, y al terminar, presentar secuencia
Â  	 	 Â  runCountdown(countdownEl, () => {
Â  	 	 Â  	 presentSequence(controller.currentSeq, controller.speed);
Â  	 	 Â  });
Â  	 	 Â Â 
Â  	 	 Â  controller.index++;Â 
Â  	 	 Â  progressEl.textContent = String(controller.index);
Â  	 Â  }

Â  	 Â  respEl.addEventListener('keydown', (e) => {
Â  	 	 Â  if(e.key === 'Enter' && controller.running && !controller.timer){
Â  	 	 Â  	 const given = respEl.value.trim();
Â  	 	 Â  	 const target = controller.currentSeq;
Â  	 	 Â  	Â 
Â  	 	 Â  	 // Â¡NUEVA LÃ“GICA DE SIMILITUD!
Â  	 	 	 Â  const sim = getSimilarity(given, target);
Â  	 	 Â  	 const correct = (sim === 1); // Solo acierto perfecto
Â  	 	 Â  	Â 
Â  	 	 Â  	 const t = {Â 
Â  	 	 Â  	 	 length: controller.len,Â 
Â  	 	 Â  	 	 type: controller.type,Â 
Â  	 	 Â  	 	 similarity: sim,Â 
Â  	 	 Â  	 	 correct: correct, // 'correct' se sigue guardando por si acaso
Â  	 	 Â  	 	 given,Â 
Â  	 	 Â  	 	 target,Â 
Â  	 	 Â  	 	 ts: Date.now()Â 
Â  	 	 	 Â  };
Â  	 	 	 Â  state.span.trials.push(t);
Â  	 	 	 Â Â 
Â  	 	 	 Â  // LÃ³gica adaptativa: si acierta perfecto, +1; si falla (cualquier similitud < 1), -1
Â  	 	 	 Â  const dir = correct ? +1 : -1;
Â  	 	 	 Â  if(controller.lastDir !== null && dir !== controller.lastDir){Â 
Â  	 	 	 Â  	 controller.reversals.push(controller.len);Â 
Â  	 	 	 Â  }
Â  	 	 	 Â  controller.lastDir = dir;
Â  	 	 	 Â  controller.len = Math.max(3, controller.len + dir);
Â  	 	 	 Â Â 
Â  	 	 	 Â  persist();
Â  	 	 	 Â Â 
Â  	 	 	 Â  // Feedback basado en similitud
Â  	 	 	 Â  if (correct) {
Â  	 	 	 Â  	 feedbackEl.innerHTML = '<span class="success">Â¡Correcto!</span>';
Â  	 	 	 Â  } else if (sim > 0.7) {
Â  	 	 	 Â  	 feedbackEl.innerHTML = `<span class="warning">Â¡Casi! (${(sim*100).toFixed(0)}% similitud)</span> <span class="detail">Era: ${escapeHtml(target)}</span>`;
Â  	 	 	 Â  } else {
Â  	 	 	 Â  	 feedbackEl.innerHTML = `<span class="error">Incorrecto (${(sim*100).toFixed(0)}%).</span> <span class="detail">Era: ${escapeHtml(target)}</span>`;
Â  	 	 	 Â  }
Â  	 	 	 Â Â 
Â  	 	 	 Â  setTimeout(nextTrial, correct ? 800 : 1200);
Â  	 	 Â  }
Â  	 Â  });

Â  	 Â  resetBtn.addEventListener('click', () => {
Â  	 	 Â  if (controller.timer) clearInterval(controller.timer);
Â  	 	 Â  controller.running = false;Â 
Â  	 	 Â  state.span.trials = [];Â 
Â  	 	 Â  state.span.estimate = null;Â 
Â  	 	 Â  controller.reversals = [];Â 
Â  	 	 Â  persist();
Â  	 	 Â Â 
Â  	 	 Â  seqEl.textContent = 'â€”';Â 
Â  	 	 Â  feedbackEl.textContent = '';Â 
Â  	 	 Â  progressEl.textContent = '0';Â 
Â  	 	 Â  totalEl.textContent = '0';Â 
Â  	 	 Â  respEl.value = '';
Â  	 	 Â  $('#spanStage').classList.add('hidden');
Â  	 	 Â  $('#spanInputGroup').classList.add('hidden');
Â  	 	 Â  seqEl.classList.add('hidden');
Â  	 	 Â  updateKpis();
Â  	 Â  });
Â  	 Â Â 
Â  	 Â  startBtn.addEventListener('click', startSpan);

Â  	 Â  // ------------------------- CHUNKING -------------------------
Â  	 Â  const chunkDisplay = $('#chunkDisplay');
Â  	 Â  const chunkResp = $('#chunkResponse');
Â  	 Â  const startChunkBtn = $('#startChunk');
Â  	 Â  const chunkTrialEl = $('#chunkTrial');
Â  	 Â  const chunkFeedback = $('#chunkFeedback');

Â  	 Â  let chunkCtrl = { phase: 0, start: 0, scenario: 'letters', pair: null };

Â  	 Â  function getScenarioPair(){
Â  	 Â  	 const sc = $('#chunkScenario').value;
Â  	 	 Â  if(sc === 'letters'){
Â  	 	 Â  	 return { raw: 'IBMSONYFBICNNUNESCO', grouped: 'IBM-SONY-FBI-CNN-UNESCO' };
Â  	 	 Â  } else if(sc === 'phone'){
Â  	 	 Â  	 return { raw: '603123456789', grouped: '603-123-456-789' };
Â  	 	 Â  } else {
Â  	 	 Â  	 return {Â 
Â  	 	 Â  	 	 raw: $('#customRaw').value || 'IBMSONYFBICNNUNESCO',Â 
Â  	 	 	 Â  	 	 grouped: $('#customGrouped').value || 'IBM-SONY-FBI-CNN-UNESCO'Â 
Â  	 	 	 Â  	 };
Â  	 	 Â  }
Â  	 Â  }

Â  	 Â  function startChunk(){
Â  	 Â  	 chunkCtrl = { phase: 0, start: 0, scenario: $('#chunkScenario').value, pair: getScenarioPair() };
Â  	 	 Â  state.chunk.results = []; // Reiniciar resultados de chunking
Â  	 	 Â  persist();
Â  	 	 Â  $('#chunkStage').classList.remove('hidden');
Â  	 	 Â  $('#chunkInputGroup').classList.add('hidden');
Â  	 	 Â  chunkDisplay.classList.add('hidden');
Â  	 	 Â  chunkFeedback.textContent = '';
Â  	 	 Â  chunkTrialEl.textContent = '1';
Â  	 	 Â Â 
Â  	 	 Â  // Empezar cuenta atrÃ¡s, luego presentar
Â  	 	 Â  runCountdown(chunkCountdownEl, () => {
Â  	 	 Â  	 presentChunk(chunkCtrl.pair.raw);
Â  	 	 Â  });
Â  	 Â  }

Â  	 Â  function presentChunk(text){
Â  	 	 Â  chunkResp.value = '';Â 
Â  	 	 Â  chunkDisplay.textContent = text;
Â  	 	 Â  chunkDisplay.classList.remove('hidden');
Â  	 	 Â Â 
Â  	 	 Â  // Mostrar 2.5 segundos
Â  	 	 Â  setTimeout(() => {Â 
Â  	 	 Â  	 chunkDisplay.classList.add('hidden');
Â  	 	 Â  	 $('#chunkInputGroup').classList.remove('hidden');
Â  	 	 Â  	 chunkResp.value = '';Â 
Â  	 	 	 Â  chunkResp.focus();Â 
Â  	 	 	 Â  chunkCtrl.start = performance.now();s
Â  	 	 Â  }, 2500);
Â  	 Â  }

Â  	 Â  function endChunkTrial(given){
Â  	 Â  	 const target = chunkCtrl.phase === 0 ? chunkCtrl.pair.raw : chunkCtrl.pair.grouped;
Â  	 	 Â  const sim = getSimilarity(given, target);
Â  	 	 Â  const ok = (sim === 1);
Â  	 	 Â  const rt = (performance.now() - chunkCtrl.start) / 1000;

Â  	 	 Â  state.chunk.results.push({Â 
Â  	 	 Â  	 scenario: chunkCtrl.scenario,Â 
Â  	 	 Â  	 phase: chunkCtrl.phase,Â 
Â  	 	 Â  	 similarity: sim,
Â  	 	 Â  	 ok: ok,Â 
Â  	 	 Â  	 rt,Â 
Â  	 	 Â  	 target,Â 
Â  	 	 Â  	 givenÂ 
Â  	 	 Â  });
Â  	 	 Â  persist();
Â  	 	 Â Â 
Â  	 	 Â  // Feedback
Â  	 	 Â  if (ok) {
Â  	 	 Â  	 chunkFeedback.innerHTML = '<span class="success">Â¡Correcto!</span>';
Â  	 	 Â  } else if (sim > 0.7) {
Â  	 	 Â  	 chunkFeedback.innerHTML = `<span class="warning">Â¡Casi! (${(sim*100).toFixed(0)}% similitud)</span>`;
Â  	 	 Â  } else {
Â  	 	 Â  	 chunkFeedback.innerHTML = `<span class="error">Incorrecto (${(sim*100).toFixed(0)}%).</span>`;
Â  	 	 Â  }

Â  	 	 Â  // TransiciÃ³n
Â  	 	 Â  if(chunkCtrl.phase === 0){
Â  	 	 Â  	 chunkCtrl.phase = 1;Â 
Â  	 	 	 Â  chunkTrialEl.textContent = '2';
_ 	 	 	 Â  chunkFeedback.innerHTML += ' <br>Ahora, la versiÃ³n <b>agrupada</b>...';
_ 	 	 	 Â  $('#chunkInputGroup').classList.add('hidden');
Â  	 	 	 Â Â 
Â  	 	 	 Â  setTimeout(() => {
Â  	 	 	 Â  	 runCountdown(chunkCountdownEl, () => {
Â  	 	 	 Â  	 	 presentChunk(chunkCtrl.pair.grouped);
Â  	 	 	 Â  	 });
Â  	 	 	 Â  }, 1200);

Â  	 	 Â  } else {
Â  	 	 Â  	 chunkFeedback.innerHTML += ' <br><span class="success">ComparaciÃ³n completada.</span> Revisa tus Resultados.';
Â  	 	 Â  	 updateKpis();
Â  	 	 Â  }
Â  	 Â  }

Â  	 Â  chunkResp.addEventListener('keydown', (e) => {
Â  	 Â  	 if(e.key === 'Enter' && !$('#chunkStage').classList.contains('hidden')){
Â  	 	 Â  	 const given = chunkResp.value.trim();
Â  	 	 Â  	 if(!given) return;
Â  	 	 Â  	 endChunkTrial(given);
Â  	 	 Â  }
Â  	 Â  });

Â  	 Â  startChunkBtn.addEventListener('click', startChunk);

Â  	 Â  function computeChunkAdvantage(arr){
Â  	 Â  	 const last = arr.slice(-2);
Â  	 	 Â  if(last.length < 2) return null;
Â  	 	 Â Â 
Â  	 	 Â  const raw = last[0].phase === 0 ? last[0] : last[1];
Â  	 	 Â  const grouped = last[0].phase === 0 ? last[1] : last[0];
Â  	 	 Â Â 
Â  	 	 Â  // Usar similitud en lugar de solo 'ok'
Â  	 	 Â  const accRaw = raw.similarity;
Â  	 	 Â  const accGrp = grouped.similarity;
Â  	 	 Â  const timeRaw = raw.rt;
Â  	 	 Â  const timeGrp = grouped.rt;
Â  	 	 Â Â 
Â  	 	 Â  const accGain = (accGrp - accRaw); // -1 a +1
Â  	 	 Â  const timeGain = (timeRaw - timeGrp) / Math.max(timeRaw, timeGrp, 0.01); // % de ahorro
Â  	 	 Â Â 
Â  	 	 Â  // PonderaciÃ³n: 60% precisiÃ³n, 40% tiempo
Â  	 	 Â  return (0.6 * accGain + 0.4 * timeGain);s
Â  	 Â  }

Â  	 Â  // ------------------------- RESULTADOS -------------------------
Â  	 Â  const chartEl = $('#chart');
Â  	 Â Â 
      // ===== INICIO DE LA CORRECCIÃ“N =====
Â  	 Â  function drawChart(){
Â  	 	 Â  const ctx = chartEl.getContext('2d');
Â  	 	 Â  ctx.clearRect(0,0,chartEl.width,chartEl.height);
Â  	 	 Â  const w = chartEl.clientWidth, h = chartEl.clientHeight;
Â  	 	 Â Â 
        // --- Â¡ARREGLO! ---
        // Necesitamos leer las variables CSS usando JavaScript
        const styles = getComputedStyle(document.documentElement);
        const colorBorder = styles.getPropertyValue('--border').trim();
        const colorMuted = styles.getPropertyValue('--muted').trim();
        // ------------------
        
Â  	 	 Â  const pad = 40;
Â  	 	 Â  ctx.strokeStyle = colorBorder; // <-- CORREGIDO
Â  	 	 Â  ctx.fillStyle = colorMuted;   // <-- CORREGIDO
Â  	 	 Â  ctx.font = '12px Inter';
Â  	 	 Â Â 
Â  	 	 Â  // Ejes
Â  	 	 Â  ctx.beginPath();
Â  	 	 Â  ctx.moveTo(pad, pad); ctx.lineTo(pad, h - pad); ctx.lineTo(w - pad, h - pad);
Â  	 	 Â  ctx.stroke();
Â  	 	 Â Â 
Â  	 	 Â  // Etiquetas Ejes
Â  	 	 Â  ctx.textAlign = 'left';
Â  	 	 Â  ctx.fillText('PrecisiÃ³n (%)', pad, pad - 10);
Â  	 	 Â  ctx.textAlign = 'center';
Â  	 	 Â  ctx.fillText('Longitud de Secuencia', w / 2, h - pad + 25);
Â  	 	 Â  ctx.textAlign = 'right';
Â  	 	 Â  ctx.fillText('100%', pad - 8, pad + 5);
Â  	 	 Â  ctx.fillText('0%', pad - 8, h - pad);

Â  	 	 Â  const trials = state.span.trials;
Â  	 	 Â  if(!trials.length) return;

Â  	 	 Â  const groups = {};
Â  	 	 Â  trials.forEach(t => {Â 
Â  	 	 Â  Â  groups[t.length] = groups[t.length] || {n:0, ok:0};Â 
Â  	 	 Â  Â  	 groups[t.length].n++;Â 
Â  	 	 Â  Â  	 if(t.similarity === 1) groups[t.length].ok++;Â 
Â  	 	 Â  });
Â  	 	 Â Â 
Â  	 	 Â  const lengths = Object.keys(groups).map(n => +n).sort((a,b) => a-b);
Â  	 	 Â  if(!lengths.length) return;
Â  	 	 Â Â 
Â  	 	 Â  const minL = Math.min(...lengths);
Â  	 	 Â  const maxL = Math.max(...lengths);
Â  	 	 Â  const numBars = (maxL - minL) + 1;
Â  	 	 Â  const xStep = (w - 2 * pad) / Math.max(numBars, 1);
Â  	 	 Â Â 
Â  	 	 Â  for (let i = 0; i <= numBars; i++) {
Â  	 	 Â  	 const L = minL + i;
Â  	 	 Â  	 const group = groups[L];
Â  	 	 Â  	 const x = pad + i * xStep;
Â  	 	 Â  	 const barW = Math.max(2, xStep * 0.7);
Â  	 	 Â  	Â 
Â  	 	 Â  	 if (group) {
Â  	 	 	 Â  	 const acc = group.ok / group.n;
Â  	 	 	 Â  	 const barH = acc * (h - 2 * pad);
Â  	 	 	 Â  	 ctx.fillStyle = 'rgba(0, 123, 255, 0.7)'; // El color --brand en RGBA (esto estaba bien)
Â  	 	 	 	 Â  ctx.fillRect(x + (xStep - barW) / 2, h - pad - barH, barW, barH);
Â  	 	 	 Â  }
Â  	 	 	 Â Â 
Â  	 	 	 Â  ctx.fillStyle = colorMuted; // <-- CORREGIDO
Â  	 	 	 Â  ctx.textAlign = 'center';
Â  	 	 	 Â  ctx.fillText(String(L), x + xStep / 2, h - pad + 14);
Â  	 	 Â  }
Â  	 Â  }
      // ===== FIN DE LA CORRECCIÃ“N =====

Â  	 Â  function exportCSV(){
Â  	 	 Â  const rows = [];
Â  	 	 Â  rows.push(['test','ts','tipo','longitud','similitud','correcto','objetivo','respuesta','rt_s','escenario','fase']);
Â  	 	 Â  state.span.trials.forEach(t => {
Â  	 	 Â  	 rows.push(['span', new Date(t.ts).toISOString(), t.type, t.length, t.similarity.toFixed(3), t.correct?'1':'0', t.target, t.given, '', '', '']);
Â  	 	 Â  });
Â  	 	 Â  state.chunk.results.forEach(c => {
Â  	 	 Â  	 rows.push(['chunk', new Date().toISOString(), '', '', c.similarity.toFixed(3), c.ok?'1':'0', c.target, c.given, c.rt.toFixed(3), c.scenario, String(c.phase)]);
Â  	 	 Â  });
Â  	 	 Â  const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
Â  	 	 Â  download('resultados_miller_lab.csv', csv, 'text/csv');
Â  	 Â  }

Â  	 Â  function clearAll(){
Â  	 	 Â  if(confirm('Â¿Seguro que deseas borrar todos los datos guardados en este navegador?')){
Â  	 	 Â  	 localStorage.removeItem(storeKey);
Â  	 	 Â  	 state.span = {trials:[], estimate:null};Â 
Â  	 	 Â  	 	 state.chunk = {results:[]};
Â  	 	 Â  	 updateKpis();Â 
Â  	 	 	 Â  drawChart();
Â  	 	 Â  }
Â  	 Â  }

Â  	 Â  $('#exportCSV').addEventListener('click', exportCSV);
Â  	 Â  $('#clearAll').addEventListener('click', clearAll);

Â  	 Â  // Init
Â  	 Â  updateKpis();
Â  	 Â  drawChart();
Â  Â  })();
Â  </script>
</body>
</html>
